@model IEnumerable<Domain.Entities.Category>
@{
    ViewBag.Title = "Track your budget";
    int m = DateTime.Now.Month;
    int y = DateTime.Now.Year;

    var account = (Domain.Entities.Account)ViewBag.Account;
}

@{
    if (Model != null && Model.Count() > 0)
    {
        <div class="col-12 mt-3">
            @{
                if (account.IsSpendingMoreThanBudget(m, y))
                {
                    <p class="alert alert-danger text-center" style="font-size:14px;">
                        <i class="far fa-thumbs-down"></i><br />
                        You should spend: $@account.GetTotalIdealDailySpending(m, y).ToString("#.##") / day <br />
                        <strong style="color:red;">But you are spending: $@account.GetTotalDailySpending(m, y).ToString("#.##") / day</strong>
                    </p>
                    <p class="alert alert-warning text-center" style="font-size:14px;">
                        <i class="fas fa-exclamation-triangle"></i><br />
                        <strong style="color:red;">@account.WaitUntilDateToSpendAgain(m, y).ToShortDateString()</strong><br />
                        Dont spend any money until this date unless it´s an emergency!
                    </p>
                }
                else
                {
                    <p class="alert alert-success text-center" style="font-size:14px;">
                        <i class="far fa-laugh-beam"></i> <br />
                        You can spend up to: @account.GetTotalIdealDailySpending(m, y).ToString("#.##") / day <br />
                        <strong style="color:green;">But you are spending: @account.GetTotalDailySpending(m, y).ToString("#.##") / day </strong>
                    </p>
                }
            }
        </div>
        <div class="row mt-3">
            @foreach (var c in Model)
            {
                <div class="col-6">
                    <div class="card shadow mb-4">
                        <div class="card-header py-3 text-center">
                            <h6 class="m-0 font-weight-bold text-primary" style="font-size:30px;"><i class="fas @c.CategoryIcon"></i></h6>
                        </div>
                        @{
                            string progressStyle = "bg-success";
                            string color = "color:black;";
                            string bg = "";
                            int budgetLeft = c.GetBudgetPercentLeft(m, y);
                            if (c.IsSpendingMoreThanBudget(m, y))
                            {
                                progressStyle = "bg-danger";
                                color = "color:red;";
                            }

                            if (c.GetBudgetPercentLeft(m, y) < 1 || account.IsSpendingMoreThanBudget(m, y))
                            {
                                bg = "background-color:#f2bcbc";
                                budgetLeft = 100;
                                color = "color:black;";
                            }
                            else
                            {
                                if (c.IsSpendingMoreThanBudget(m, y))
                                {
                                    bg = "background-color:#ffe04b";
                                }
                                else
                                {
                                    bg = "background-color:#95d198";
                                }
                            }
                        }
                        <div class="card-body text-center" style="@bg; min-height:200px;">
                            <div class="progress">
                                <div class="progress-bar @progressStyle" role="progressbar" style="width: @budgetLeft%;@color" aria-valuenow="@c.GetBudgetPercentLeft(m, y)" aria-valuemin="0" aria-valuemax="100">$@(Convert.ToInt32(c.Budget - c.GetActivitiesSum(m, y)))</div>
                            </div>
                            <div class="row">
                                <div class="col-6 text-left" style="font-size:10px;@color">
                                    $@Convert.ToInt32(c.GetActivitiesSum(m, y))
                                </div>
                                <div class="col-6 text-right" style="font-size:10px;">
                                    $@Convert.ToInt32(@c.Budget)
                                </div>
                                <hr />
                                <div class="col-12 text-left">
                                    @if (c.GetBudgetPercentLeft(m, y) < 1 || account.IsSpendingMoreThanBudget(m, y))
                                    {
                                        <p class="alert alert-danger text-center" style="font-size:16px;"><i class="fas fa-bomb"></i> <strong>$0</strong></p>
                                    }
                                    else
                                    {
                                        if (c.IsSpendingMoreThanBudget(m, y))
                                        {
                                            <p class="alert alert-warning text-center" style="font-size:16px;"><i class="far fa-hand-paper"></i> <strong>$@c.GetProportionalDailySpendingLeft(m, y).ToString("#.##")</strong></p>
                                        }
                                        else
                                        {
                                            <p class="alert alert-success text-center" style="font-size:16px;"><i class="far fa-thumbs-up"></i> <strong>$@c.GetProportionalDailySpendingLeft(m, y).ToString("#.##")</strong></p>
                                        }
                                    }
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-6">
                                    <a class="form-control btn btn-info" href="@Url.Action("ActivityHistory", "Expenses", new { category = c.Id, month = m, y })">
                                        <i class="fas fa-history"></i>
                                    </a>
                                </div>
                                <div class="col-6">
                                    <button class="form-control btn btn-success" type="button" onclick="OpenAddModal(@c.Id)">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
        <p class="text-center" style="font-size:12px;">Total spent: $@account.GetTotalSpending(m, y).ToString("#.##") / Total budget: $@account.GetTotalBudget(m, y).ToString("#.##")</p>
        <a href="@Url.Action("Setup", "Categories")" class="form-control btn btn-primary mt-2">Edit Categories</a>

        <div class="modal modalAddActivity" tabindex="-1" role="dialog">
            <div class="modal-dialog" role="document">
                <form action="@Url.Action("AddActivity", "Expenses")" method="post">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add income or expense</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="md-content">
                                <p>How much?</p>
                                <input type="hidden" id="catId" name="catId" />
                                <input type="number" id="value" name="value" class="form-control p-3" placeholder="$100" />
                                <input type="text" id="description" name="description" class="form-control p-3" placeholder="eg. christmas gifts!" />
                            </div>
                            <div class="md-load text-center p-3" style="display:none;">
                                <img src="~/images/_loading.gif" />
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="submit" class="form-control btn btn-primary" onclick="AddActivity()">Save</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    }
    else
    {
        <a href="@Url.Action("SetUp", "Categories")" class="form-control btn btn-primary mt-2 disabled">Please add categories to track first</a>
    }
}

@section scripts{
    <script type="text/javascript">
        function OpenAddModal(c) {
            $('#catId').val(c);
            $('.modalAddActivity').modal('show')
        }

        function AddActivity() {
            $(".md-content").fadeOut(function () {
                $(".md-load").fadeIn();
            });
        }
    </script>
}